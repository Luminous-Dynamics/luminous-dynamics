// Œ©17: Collective Breathing - Living Glyph Card
// When many breathe as one, the field transforms

const collectiveBreathingData = {
    id: 'Œ©17',
    name: 'Collective Breathing',
    symbol: 'üå¨Ô∏èü´Å',
    type: 'foundational',
    category: 'group-practices',
    subcategory: 'collective-coherence',
    primaryHarmony: 'coherence',
    supportingHarmonies: ['resonance', 'vitality'],
    
    description: 'The ancient practice of breathing together as one organism. When a group synchronizes breath, individual boundaries dissolve into collective presence, creating a unified field of consciousness.',
    
    purpose: 'To create group coherence through synchronized breathing, establishing a shared field of presence that amplifies healing, creativity, and collective wisdom.',
    
    coreElements: {
        unifiedRhythm: 'Finding the group\'s natural breath',
        fieldAmplification: 'Collective presence multiplies power',
        nervousSystemHarmony: 'Group co-regulation',
        consciousnessWeaving: 'Individual threads become fabric',
        sacredContainer: 'Breathing creates sacred space'
    },
    
    practices: {
        basic: {
            duration: '10-15 minutes',
            description: 'Simple circle breathing for group coherence',
            steps: [
                'Form a circle, sitting or standing comfortably',
                'Join hands or place hands on neighbors\' shoulders',
                'Close eyes and breathe naturally for a minute',
                'Facilitator begins audible breathing at steady pace',
                'Group gradually joins the rhythm',
                'Continue for 10 minutes, feeling the unified field',
                'End with three deep breaths together'
            ]
        },
        
        intermediate: {
            duration: '20-30 minutes',
            description: 'Wave breathing with movement and sound',
            steps: [
                'Stand in circle, arms\' length apart',
                'Begin with individual breathing awareness',
                'Facilitator initiates slow inhale with arms rising',
                'Wave of breath moves around circle',
                'Add gentle humming on exhale',
                'Increase pace gradually, then slow again',
                'End in stillness, feeling collective presence'
            ]
        },
        
        advanced: {
            duration: '45-60 minutes',
            description: 'Sacred breathing ceremony with intentions',
            steps: [
                'Create sacred space with candles or altar',
                'Share individual intentions for collective field',
                'Begin with coherence breathing (5-5-5)',
                'Move to circular breathing (no pause)',
                'Add toning or sacred sounds',
                'Include periods of breath retention',
                'Close with silent integration'
            ]
        }
    },
    
    guidedPractice: {
        title: 'Circle of Breath Ceremony',
        duration: 600, // 10 minutes
        steps: [
            {
                time: 0,
                instruction: 'Form your circle, connect through touch or presence',
                duration: 60
            },
            {
                time: 60,
                instruction: 'Close your eyes, notice your natural breath',
                duration: 60
            },
            {
                time: 120,
                instruction: 'Begin to sense the breathing of those beside you',
                duration: 60
            },
            {
                time: 180,
                instruction: 'Inhale together for 4 counts... 1, 2, 3, 4',
                duration: 4
            },
            {
                time: 184,
                instruction: 'Exhale together for 4 counts... 1, 2, 3, 4',
                duration: 4
            },
            {
                time: 188,
                instruction: 'Continue this rhythm, breathing as one being',
                duration: 180
            },
            {
                time: 368,
                instruction: 'Feel the unified field you\'ve created together',
                duration: 60
            },
            {
                time: 428,
                instruction: 'Begin to deepen your breath naturally',
                duration: 60
            },
            {
                time: 488,
                instruction: 'Take three final breaths together',
                duration: 72
            },
            {
                time: 560,
                instruction: 'Open your eyes, see your circle with new awareness',
                duration: 40
            }
        ]
    },
    
    variations: {
        virtual: 'Online circles using synchronized audio guidance',
        walking: 'Group walking meditation with breath rhythm',
        chanting: 'Add sacred sounds or mantras to breath',
        elements: 'Breathe with different qualities (fire, water, earth, air)'
    },
    
    integration: {
        meetings: 'Start gatherings with 2-minute coherence breathing',
        family: 'Daily family breathing circle before meals',
        workplace: 'Team breathing before creative sessions',
        ceremony: 'Foundation for all sacred gatherings'
    },
    
    groupDynamics: {
        minimumSize: 3,
        optimalSize: 7-12,
        maximumSize: 'Unlimited with experienced facilitation',
        formation: 'Circle preferred, rows acceptable',
        leadership: 'Rotate leadership to build group capacity'
    },
    
    indicators: {
        mastery: [
            'Group finds rhythm within 30 seconds',
            'Breath continues synchronized without effort',
            'Palpable field of coherence generated',
            'Individual anxiety dissolves in group field',
            'Spontaneous insights arise from collective'
        ],
        
        resistance: [
            'Self-consciousness about breathing sounds',
            'Inability to surrender individual rhythm',
            'Distraction by others\' breathing patterns',
            'Fear of losing individual identity',
            'Competitive breathing or showing off'
        ],
        
        integration: [
            'Natural breath awareness in groups',
            'Calming influence in chaotic situations',
            'Intuitive rhythm matching with others',
            'Enhanced group creativity and flow',
            'Deeper empathy and connection'
        ]
    },
    
    facilitationTips: {
        preparation: 'Practice audible breathing beforehand',
        pacing: 'Start slower than feels natural',
        inclusion: 'Adapt for different lung capacities',
        safety: 'Watch for hyperventilation signs',
        closing: 'Always include integration time'
    },
    
    scientificBasis: {
        heartRateVariability: 'Group HRV synchronization documented',
        neuralCoupling: 'Brain waves entrain during collective breathing',
        oxygenation: 'Improved cellular oxygenation in group',
        stressReduction: 'Cortisol drops more in group than solo',
        socialBonding: 'Oxytocin release enhanced in group breathing'
    },
    
    traditionalRoots: {
        pranayama: 'Yogic group breathing practices',
        qigong: 'Collective qi cultivation',
        sufi: 'Dhikr breathing ceremonies',
        hawaiian: 'Ha breathing circles',
        african: 'Rhythmic breathing with drums'
    },
    
    sacredGeometry: {
        pattern: 'Flower of Life - overlapping circles',
        rhythm: 'Golden ratio breathing (1.618:1)',
        formation: 'Sacred circle or spiral',
        energetic: 'Torus field generated by group'
    },
    
    breathPatterns: {
        coherence: { inhale: 5, exhale: 5 },
        calming: { inhale: 4, exhale: 8 },
        energizing: { inhale: 6, exhale: 2 },
        balance: { inhale: 4, hold: 4, exhale: 4, hold: 4 }
    },
    
    music: {
        suggested: 'Drone sounds, singing bowls, ocean waves',
        rhythm: '60-70 BPM for heart coherence',
        avoid: 'Complex melodies that distract from breath'
    },
    
    prerequisites: [
        'Œ©8: Inner Coherence',
        'Œ©16: Somatic Synchrony',
        'Basic breath awareness'
    ],
    
    nextPractices: [
        '‚àë7: Collective Emergence Protocol',
        'Advanced pranayama techniques',
        'Sound healing integration'
    ],
    
    cautionNotes: [
        'Not for those with severe respiratory conditions',
        'Pregnancy modifications needed',
        'Stop if dizziness or tingling occurs',
        'Keep space well-ventilated',
        'Honor individual limits always'
    ],
    
    onlineAdaptations: {
        platform: 'Use gallery view to see whole circle',
        audio: 'One person guides, others mute',
        synchronization: 'Use metronome or music for timing',
        connection: 'Visualize energy links between participants'
    },
    
    journalPrompts: [
        'How did it feel to breathe as one being?',
        'What arose when I surrendered my rhythm?',
        'What did the collective field teach me?',
        'How can I carry group coherence into daily life?',
        'What wants to emerge from our unified breathing?'
    ]
};

// Class implementation
class CollectiveBreathingCard extends LivingGlyphCard {
    constructor() {
        super(collectiveBreathingData);
        this.groupSize = 1;
        this.breathTimer = null;
        this.currentPattern = 'coherence';
        this.groupCoherence = 0;
    }
    
    initializePractice() {
        super.initializePractice();
        this.initializeGroupFeatures();
        this.startBreathingPattern();
    }
    
    initializeGroupFeatures() {
        // Create group size selector
        const selector = this.querySelector('.group-size-selector');
        if (selector) {
            selector.addEventListener('change', (e) => {
                this.groupSize = parseInt(e.target.value);
                this.updateGroupVisualization();
            });
        }
        
        // Pattern selector
        const patternSelector = this.querySelector('.pattern-selector');
        if (patternSelector) {
            patternSelector.addEventListener('change', (e) => {
                this.currentPattern = e.target.value;
                this.restartBreathingPattern();
            });
        }
    }
    
    startBreathingPattern() {
        const pattern = this.data.breathPatterns[this.currentPattern];
        let phase = 'inhale';
        let phaseTime = pattern.inhale * 1000;
        
        const runPhase = () => {
            this.updateBreathPhase(phase);
            
            // Calculate next phase
            if (phase === 'inhale' && pattern.hold) {
                phase = 'hold';
                phaseTime = pattern.hold * 1000;
            } else if (phase === 'inhale' || phase === 'hold') {
                phase = 'exhale';
                phaseTime = pattern.exhale * 1000;
            } else if (phase === 'exhale' && pattern.hold) {
                phase = 'pause';
                phaseTime = pattern.hold * 1000;
            } else {
                phase = 'inhale';
                phaseTime = pattern.inhale * 1000;
            }
            
            this.breathTimer = setTimeout(runPhase, phaseTime);
        };
        
        runPhase();
    }
    
    updateBreathPhase(phase) {
        const visual = this.querySelector('.breath-visual');
        if (visual) {
            visual.className = `breath-visual ${phase}`;
            visual.textContent = this.getPhaseSymbol(phase);
        }
        
        // Update group coherence based on practice
        this.updateGroupCoherence();
    }
    
    getPhaseSymbol(phase) {
        const symbols = {
            inhale: 'üå¨Ô∏è ‚Üë',
            hold: 'ü´Å ‚è∏',
            exhale: 'üå¨Ô∏è ‚Üì',
            pause: 'ü´Å ‚è∏'
        };
        return symbols[phase] || 'ü´Å';
    }
    
    updateGroupCoherence() {
        // Simulate group coherence building over time
        this.groupCoherence = Math.min(100, this.groupCoherence + (this.groupSize * 0.5));
        
        const display = this.querySelector('.coherence-meter');
        if (display) {
            display.style.width = `${this.groupCoherence}%`;
            display.style.backgroundColor = `hsl(${this.groupCoherence * 1.2}, 70%, 50%)`;
        }
    }
    
    updateGroupVisualization() {
        const container = this.querySelector('.group-visualization');
        if (!container) return;
        
        container.innerHTML = '';
        const angleStep = (2 * Math.PI) / this.groupSize;
        
        for (let i = 0; i < this.groupSize; i++) {
            const angle = i * angleStep - Math.PI / 2;
            const x = 50 + 40 * Math.cos(angle);
            const y = 50 + 40 * Math.sin(angle);
            
            const person = document.createElement('div');
            person.className = 'group-member';
            person.style.left = `${x}%`;
            person.style.top = `${y}%`;
            person.innerHTML = 'üßò';
            container.appendChild(person);
        }
    }
    
    restartBreathingPattern() {
        clearTimeout(this.breathTimer);
        this.startBreathingPattern();
    }
    
    completePractice() {
        clearTimeout(this.breathTimer);
        
        const results = {
            duration: this.getPracticeDuration(),
            groupSize: this.groupSize,
            pattern: this.currentPattern,
            coherenceAchieved: this.groupCoherence,
            timestamp: new Date()
        };
        
        this.saveResults(results);
        super.completePractice();
    }
    
    render() {
        return `
            ${super.render()}
            <div class="collective-breathing-features">
                <div class="group-settings">
                    <label>
                        Group Size:
                        <input type="range" class="group-size-selector" 
                               min="1" max="20" value="7" />
                        <span class="group-size-display">7</span>
                    </label>
                    
                    <label>
                        Pattern:
                        <select class="pattern-selector">
                            <option value="coherence">Coherence (5-5)</option>
                            <option value="calming">Calming (4-8)</option>
                            <option value="energizing">Energizing (6-2)</option>
                            <option value="balance">Balance (4-4-4-4)</option>
                        </select>
                    </label>
                </div>
                
                <div class="breath-visual">ü´Å</div>
                
                <div class="group-visualization"></div>
                
                <div class="coherence-container">
                    <div class="coherence-label">Group Coherence</div>
                    <div class="coherence-bar">
                        <div class="coherence-meter"></div>
                    </div>
                </div>
            </div>
            
            <style>
                .collective-breathing-features {
                    text-align: center;
                    padding: 2rem;
                }
                
                .group-settings {
                    display: flex;
                    gap: 2rem;
                    justify-content: center;
                    margin-bottom: 2rem;
                }
                
                .group-settings label {
                    display: flex;
                    flex-direction: column;
                    gap: 0.5rem;
                }
                
                .breath-visual {
                    font-size: 4rem;
                    margin: 2rem 0;
                    transition: all 1s ease;
                }
                
                .breath-visual.inhale {
                    transform: scale(1.3);
                    filter: brightness(1.2);
                }
                
                .breath-visual.exhale {
                    transform: scale(0.8);
                    filter: brightness(0.8);
                }
                
                .group-visualization {
                    position: relative;
                    width: 200px;
                    height: 200px;
                    margin: 2rem auto;
                    border: 2px dashed rgba(255, 255, 255, 0.2);
                    border-radius: 50%;
                }
                
                .group-member {
                    position: absolute;
                    font-size: 1.5rem;
                    transform: translate(-50%, -50%);
                    animation: breathe 5s ease-in-out infinite;
                }
                
                @keyframes breathe {
                    0%, 100% { transform: translate(-50%, -50%) scale(1); }
                    50% { transform: translate(-50%, -50%) scale(1.1); }
                }
                
                .coherence-container {
                    margin-top: 2rem;
                }
                
                .coherence-bar {
                    width: 100%;
                    height: 20px;
                    background: rgba(255, 255, 255, 0.1);
                    border-radius: 10px;
                    overflow: hidden;
                    margin-top: 0.5rem;
                }
                
                .coherence-meter {
                    height: 100%;
                    width: 0%;
                    transition: all 0.5s ease;
                    border-radius: 10px;
                }
                
                .group-size-display {
                    font-weight: bold;
                    color: #667eea;
                }
            </style>
        `;
    }
}

// Register the card
customElements.define('collective-breathing-card', CollectiveBreathingCard);

// Export for use
export { CollectiveBreathingCard, collectiveBreathingData };